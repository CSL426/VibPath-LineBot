"""
Postback event handler for LINE Bot.
Handles postback actions from buttons and manages explanation responses.
"""
import logging
from typing import Dict, Any, Optional
from linebot.models import TextSendMessage, FlexSendMessage, QuickReply

logger = logging.getLogger(__name__)


class PostbackHandler:
    """Handles postback events and explanation responses"""

    def __init__(self):
        self.explanations = self._initialize_explanations()

    def _initialize_explanations(self) -> Dict[str, str]:
        """Initialize explanation content (you can modify these later)"""
        return {
            "explain_company": """ðŸ¢ VibPath é »çŽ‡æ²»ç™‚ä¸­å¿ƒ

æˆ‘å€‘æ˜¯å°ˆæ¥­çš„é »çŽ‡æ²»ç™‚è¨­å‚™è£½é€ å•†ï¼Œå°ˆç²¾æ–¼æ¥µä½Žé »é›»ç£æ³¢æŠ€è¡“ï¼Œè‡´åŠ›æ–¼ç‚ºå®¢æˆ¶æä¾›é«˜å“è³ªçš„é »çŽ‡æ²»ç™‚é«”é©—ã€‚

ðŸŽ¯ æˆ‘å€‘çš„ä½¿å‘½ï¼š
é€éŽç²¾æº–çš„é »çŽ‡èª¿ç¯€æŠ€è¡“ï¼Œå¹«åŠ©æ¯å€‹äººæ‰¾å›žå…§åœ¨çš„å’Œè«§èˆ‡å¹³è¡¡ã€‚

ðŸ”¬ æ ¸å¿ƒæŠ€è¡“å„ªå‹¢ï¼š
â€¢ æ³¢å½¢æ¥µä½Žå¤±çœŸåº¦ - ç¢ºä¿æ²»ç™‚æ•ˆæžœæœ€å¤§åŒ–
â€¢ ç£å ´å¼·åº¦å……è¶³ - æä¾›æ›´æ·±å±¤çš„å…±æŒ¯æ•ˆæžœ
â€¢ æ³¢å½¢ç´”æ·¨ç©©å®š - æ¯ä¸€å°æ©Ÿå™¨éƒ½ç¶“éŽç²¾å¯†èª¿æ ¡
â€¢ å°ˆæ¥­é »çŽ‡é…æ–¹ - åŸºæ–¼ç§‘å­¸ç ”ç©¶å’Œå¯¦å‹™ç¶“é©—

âš¡ ç”¢å“ç‰¹è‰²ï¼š
â€¢ ä¸åªä¿®è¡Œäººé©ç”¨ï¼Œä¸€èˆ¬äººä¹Ÿèƒ½è¼•é¬†ä½¿ç”¨
â€¢ æ¶µè“‹åŠ©çœ ã€å°ˆæ³¨ã€ä¿®è¡Œç­‰å¤šå…ƒéœ€æ±‚
â€¢ æ¯æ¬¾ç”¢å“éƒ½å…·å‚™å“è¶Šçš„æŠ€è¡“è¦æ ¼
â€¢ é•·æœŸä½¿ç”¨å®‰å…¨å¯é 

âœ¨ æœå‹™ç†å¿µï¼š
ä»¥æŠ€è¡“ç‚ºæœ¬ï¼Œç”¨å¿ƒè£½é€ æ¯ä¸€å°è¨­å‚™ï¼Œè®“é »çŽ‡æ²»ç™‚çœŸæ­£ç™¼æ®æ‡‰æœ‰çš„æ•ˆæžœã€‚

ðŸ“ž æ­¡è¿Žé«”é©—æˆ‘å€‘çš„å°ˆæ¥­ç”¢å“ï¼Œæ„Ÿå—é«˜å“è³ªé »çŽ‡æ²»ç™‚çš„ç¥žå¥‡åŠ›é‡ï¼""",

            "explain_frequency": """ðŸŽµ é »çŽ‡æ²»ç™‚åŽŸç†èªªæ˜Ž

é »çŽ‡æ²»ç™‚æ˜¯é‹ç”¨ç‰¹å®šçš„æ¥µä½Žé »é›»ç£æ³¢ä¾†èª¿ç¯€èº«å¿ƒç‹€æ…‹çš„è‡ªç„¶ç™‚æ³•ã€‚

ðŸ§  ç§‘å­¸åŸºç¤Žï¼š
â€¢ å¤§è…¦æœƒèˆ‡å¤–éƒ¨é »çŽ‡ç”¢ç”Ÿå…±æŒ¯ç¾è±¡
â€¢ ä¸åŒé »çŽ‡å°æ‡‰ä¸åŒçš„è…¦æ³¢ç‹€æ…‹
â€¢ Î±æ³¢(7.83-8Hz)ï¼šå¤§è…¦éœä¸‹ä¾†å¾Œçš„ç‹€æ…‹ï¼ŒåŠ©çœ æ•ˆæžœ
â€¢ Î¸æ³¢(4Hz)ï¼šé†’ç¡ä¹‹é–“çš„è…¦æ³¢ï¼Œæ¯”Î±æ³¢æ›´ç©æ¥µçš„åŠ©çœ ä½œç”¨
â€¢ Î³æ³¢(40Hz)ï¼šé«˜åº¦å°ˆæ³¨æ™‚çš„å¤§è…¦è…¦æ³¢

âš¡ æˆ‘å€‘çš„æŠ€è¡“ç‰¹è‰²ï¼š
â€¢ æ³¢å½¢éƒ½å¾ˆæ¼‚äº®ï¼Œç¸½è«§æ³¢å¤±çœŸåº¦éƒ½å¾ˆä½Ž
â€¢ ç£å ´å¼·åº¦éƒ½å¾ˆè¶³ï¼Œèƒ½ç™¼æ®æ›´å¥½æ•ˆæžœ
â€¢ æ¯ä¸€å°æ©Ÿå™¨éƒ½ç¶“éŽç²¾å¯†èª¿æ ¡
â€¢ ä¸åªä¿®è¡Œäººè¼”åŠ©å¥½ç”¨ï¼Œä¸€èˆ¬äººç”¨ä¹Ÿéƒ½å¾ˆå¥½

ðŸŽ¯ ä¸»è¦æ‡‰ç”¨ï¼š
â€¢ åŠ©çœ æ”¾é¬†ï¼šèˆ’æ›¼æ³¢ã€Î±æ³¢ã€Î¸æ³¢
â€¢ æå‡å°ˆæ³¨ï¼šÎ³æ³¢(40Hz)
â€¢ ä¿®è¡Œè¼”åŠ©ï¼šÎ¸æ³¢å¹«åŠ©é€²å…¥æ›´æ·±çš„å®šéœç‹€æ…‹
â€¢ è„ˆè¼ªèª¿ç†ï¼š13é »è„ˆè¼ªæ³¢å°æ‡‰ç‘œçˆç³»çµ±

ðŸŒŸ ä½¿ç”¨æ•ˆæžœï¼š
â€¢ Î¸æ³¢(4Hz)ç‰¹åˆ¥é©åˆä¿®è¡Œäººï¼Œå¹«åŠ©ä¿®è¡Œæ™‚æ›´å®¹æ˜“é€²å…¥æ·±å±¤å®šéœç‹€æ…‹
â€¢ æ‰€æœ‰ç”¢å“å…±åŒç‰¹é»žï¼šæ³¢å½¢ç´”æ·¨ã€å¤±çœŸåº¦ä½Žã€ç£å ´å¼·åº¦è¶³""",

            "explain_7_83hz": """ðŸŒ 7.83Hz èˆ’æ›¼å…±æŒ¯ç™‚æ³•

7.83Hz æ˜¯åœ°çƒçš„åŸºæœ¬æŒ¯å‹•é »çŽ‡ï¼Œè¢«ç¨±ç‚ºã€Œåœ°çƒå¿ƒè·³ã€ï¼Œæ˜¯å¤§å®¶ä¸€èˆ¬æ‰€çŸ¥çš„æ¥µä½Žé »é›»ç£æ³¢ï¼Œä¸»è¦ç”¨æ–¼åŠ©çœ ã€‚

ðŸ”¬ ç§‘å­¸ç™¼ç¾ï¼š
â€¢ 1952å¹´ç”±ç‰©ç†å­¸å®¶èˆ’æ›¼ç™¼ç¾
â€¢ åœ°çƒé›»é›¢å±¤çš„è‡ªç„¶å…±æŒ¯é »çŽ‡
â€¢ å±¬æ–¼Î±æ³¢ç¯„åœï¼Œæ˜¯å¤§è…¦éœä¸‹ä¾†å¾Œçš„è…¦æ³¢ç‹€æ…‹
â€¢ èˆ‡äººé«”ç”Ÿç‰©ç¯€å¾‹é«˜åº¦å»åˆ

âš¡ æˆ‘å€‘çš„æŠ€è¡“å„ªå‹¢ï¼š
âœ… æ³¢å½¢æ¥µä½Žå¤±çœŸåº¦ - ç¢ºä¿ç´”æ·¨çš„é »çŽ‡è¼¸å‡º
âœ… ç£å ´å¼·åº¦å……è¶³ - èƒ½ç™¼æ®æ›´å¥½çš„åŠ©çœ æ•ˆæžœ
âœ… æ³¢å½¢ç©©å®šç´”æ·¨ - ç¶“éŽç²¾å¯†èª¿æ ¡çš„å°ˆæ¥­è¨­å‚™
âœ… 8Hzå„ªåŒ–ç‰ˆæœ¬ - æ ¹æ“šç¶“é©—ï¼Œæ•ˆæžœæ¯”7.83Hzæ›´ä½³

ðŸŒ± ä¸»è¦åŠŸæ•ˆï¼š
â€¢ æ·±åº¦æ”¾é¬†èº«å¿ƒï¼Œæœ‰æ•ˆåŠ©çœ 
â€¢ é‡‹æ”¾æ—¥å¸¸ç´¯ç©çš„å£“åŠ›
â€¢ å¹³è¡¡æƒ…ç·’æ³¢å‹•
â€¢ æ”¹å–„ç¡çœ å“è³ª
â€¢ å¹«åŠ©é€²å…¥æ·±å±¤ä¼‘æ¯ç‹€æ…‹

ðŸ§˜ é©åˆæ—ç¾¤ï¼š
â€¢ å¤±çœ å›°æ“¾è€…
â€¢ å·¥ä½œå£“åŠ›å¤§çš„ä¸Šç­æ—
â€¢ éœ€è¦æ·±åº¦æ”¾é¬†çš„äºº
â€¢ æƒ³æ”¹å–„ç¡çœ å“è³ªçš„äºº

â° ä½¿ç”¨å»ºè­°ï¼š
ç¡å‰ä½¿ç”¨30-60åˆ†é˜ï¼Œå¹«åŠ©èº«å¿ƒæ”¾é¬†ï¼Œè‡ªç„¶é€²å…¥æ·±å±¤ç¡çœ ç‹€æ…‹ã€‚""",

            "explain_13Freq": """ðŸ•‰ï¸ 13é »è„ˆè¼ªæ³¢ç™‚æ³•

13é »è„ˆè¼ªæ³¢ï¼Œå¦‚å…¶åã€Œè„ˆè¼ªã€ï¼Œå±¬æ–¼ç‘œçˆç³»çµ±ï¼Œå°æ‡‰å¾žæµ·åº•è¼ªåˆ°é ‚è¼ªçš„å®Œæ•´èƒ½é‡ä¸­å¿ƒèª¿ç†ã€‚

ðŸ”® è„ˆè¼ªç³»çµ±èªªæ˜Žï¼š
â€¢ å…±13å€‹é »çŽ‡å°æ‡‰ä¸åŒè„ˆè¼ªä½ç½®
â€¢ å¾žæµ·åº•è¼ªåˆ°é ‚è¼ªçš„å®Œæ•´è¦†è“‹
â€¢ çµåˆå¤è€ç‘œçˆæ™ºæ…§èˆ‡ç¾ä»£é »çŽ‡æŠ€è¡“
â€¢ æ¯å€‹é »çŽ‡éƒ½ç¶“éŽç²¾å¯†èª¿æ ¡

âš¡ æŠ€è¡“ç‰¹è‰²ï¼š
âœ… æ³¢å½¢æ¥µä½Žå¤±çœŸåº¦ - ç¢ºä¿ç´”æ·¨çš„è„ˆè¼ªå…±æŒ¯
âœ… ç£å ´å¼·åº¦å……è¶³ - æ·±å±¤æ¿€æ´»èƒ½é‡ä¸­å¿ƒ
âœ… 13å€‹å°ˆæ¥­é »çŽ‡ - å°æ‡‰å®Œæ•´è„ˆè¼ªç³»çµ±
âœ… æ³¢å½¢ç©©å®šç´”æ·¨ - æ¯ä¸€å°éƒ½ç¶“éŽç²¾å¯†èª¿æ ¡

ðŸŽ¯ ä¸»è¦åŠŸæ•ˆï¼š
â€¢ å¹³è¡¡èº«é«”å„å€‹èƒ½é‡ä¸­å¿ƒ
â€¢ èª¿ç†ç›¸å°ä½ç½®çš„å¥åº·ç‹€æ³
â€¢ ä¿ƒé€²èƒ½é‡æµå‹•é †æš¢
â€¢ å¢žå¼·èº«å¿ƒéˆæ•´é«”å’Œè«§
â€¢ è¼”åŠ©å†¥æƒ³ä¿®è¡Œé€²å…¥æ›´æ·±å±¤ç‹€æ…‹

ðŸ§˜ é©åˆæ—ç¾¤ï¼š
â€¢ ä¿®è¡Œäººå£« - çµ•ä½³çš„ä¿®è¡Œè¼”åŠ©å·¥å…·
â€¢ ç‘œçˆç·´ç¿’è€… - æ·±åŒ–ç·´ç¿’æ•ˆæžœ
â€¢ èº«å¿ƒèª¿ç†éœ€æ±‚è€… - å¹³è¡¡èƒ½é‡ç‹€æ…‹
â€¢ ä¸€èˆ¬äººæ—¥å¸¸ä¿å¥ - ç¶­æŒèƒ½é‡æµå‹•

ðŸŒŸ ä½¿ç”¨æ•ˆæžœï¼š
é™¤äº†ä¿®è¡Œäººè¼”åŠ©ä½¿ç”¨å¤–ï¼Œä¸€èˆ¬äººä½¿ç”¨ä¹Ÿéƒ½å¾ˆæœ‰å¹«åŠ©ï¼Œèƒ½æ„Ÿå—åˆ°èº«å¿ƒèƒ½é‡çš„å¹³è¡¡èˆ‡æµå‹•ã€‚

â° ä½¿ç”¨å»ºè­°ï¼š
å»ºè­°åœ¨å®‰éœç’°å¢ƒä¸­ä½¿ç”¨ï¼Œæ­é…å†¥æƒ³æˆ–ç‘œçˆç·´ç¿’ï¼Œæ¯æ¬¡30-60åˆ†é˜ã€‚""",

            "explain_40hz": """âš¡ 40Hz Î³æ³¢é »çŽ‡ç™‚æ³•

40Hz æ˜¯äººé«˜åº¦å°ˆæ³¨æ™‚å¤§è…¦çš„è…¦æ³¢ï¼Œä½¿ç”¨ç›®çš„æ˜¯æœŸæœ›èª˜ç™¼å¤§è…¦çš„åŒæ­¥æ€§ï¼Œä¿ƒä½¿æé«˜å°ˆæ³¨åŠ›ã€‚

ðŸ”¬ ç§‘å­¸ç ”ç©¶ï¼š
â€¢ é€™æ˜¯äººé«˜åº¦å°ˆæ³¨æ™‚å¤§è…¦çš„è…¦æ³¢ç‹€æ…‹
â€¢ èª˜ç™¼å¤§è…¦åŒæ­¥æ€§ï¼Œæé«˜å°ˆæ³¨åŠ›
â€¢ åœ¨é†«å­¸ä¸Šæœ‰ä¸å°‘ç ”ç©¶æ”¯æŒ
â€¢ å¯ä»¥æœå°‹ã€ŒMIT 40HZã€äº†è§£ç›¸é—œç ”ç©¶

âš¡ æŠ€è¡“ç‰¹è‰²ï¼š
âœ… æ³¢å½¢æ¥µä½Žå¤±çœŸåº¦ - ç¢ºä¿ç´”æ·¨çš„Î³æ³¢è¼¸å‡º
âœ… ç£å ´å¼·åº¦å……è¶³ - æœ‰æ•ˆèª˜ç™¼å¤§è…¦åŒæ­¥
âœ… æ³¢å½¢ç©©å®šç´”æ·¨ - ç¶“éŽç²¾å¯†èª¿æ ¡
âœ… å°ˆæ¥­ç´šé »çŽ‡ - ç¬¦åˆç ”ç©¶æ¨™æº–çš„40Hz

ðŸŽ¯ ä¸»è¦åŠŸæ•ˆï¼š
â€¢ æé«˜å°ˆæ³¨åŠ›å’Œæ³¨æ„åŠ›
â€¢ ä¿ƒé€²å¤§è…¦åŒæ­¥æ€§
â€¢ å¢žå¼·èªçŸ¥åŠŸèƒ½
â€¢ æ”¹å–„å­¸ç¿’æ•ˆçŽ‡
â€¢ è¼”åŠ©æ·±åº¦å°ˆæ³¨ç‹€æ…‹

ðŸ§˜ é©åˆæ—ç¾¤ï¼š
â€¢ éœ€è¦é«˜åº¦å°ˆæ³¨çš„å·¥ä½œè€…
â€¢ å­¸ç¿’è€…å’Œç ”ç©¶äººå“¡
â€¢ ä¿®è¡Œäººå£«
â€¢ ä¸€èˆ¬äººæå‡å°ˆæ³¨åŠ›éœ€æ±‚

ðŸŒŸ ä½¿ç”¨æ•ˆæžœï¼š
ä¸åªä¿®è¡Œäººè¼”åŠ©å¥½ç”¨ï¼Œä¸€èˆ¬äººç”¨ä¹Ÿéƒ½å¾ˆå¥½ï¼Œèƒ½æ˜Žé¡¯æ„Ÿå—åˆ°å°ˆæ³¨åŠ›çš„æå‡ã€‚

â° ä½¿ç”¨å»ºè­°ï¼š
éœ€è¦å°ˆæ³¨æ™‚ä½¿ç”¨ï¼Œæ¯æ¬¡15-45åˆ†é˜ï¼Œå¯æ­é…å­¸ç¿’æˆ–å·¥ä½œä½¿ç”¨ã€‚""",

            "explain_double_freq": """ðŸ”„ é›™é »è¤‡åˆæ²»ç™‚æ³•

çµåˆå¤šç¨®é »çŽ‡çš„è¤‡åˆç™‚æ³•ï¼Œæä¾›æ›´å…¨é¢çš„èº«å¿ƒéˆç™‚ç™’é«”é©—ã€‚

ðŸŽµ è¤‡åˆåŽŸç†ï¼š
â€¢ åŒæ™‚é‹ç”¨å¤šå€‹æ²»ç™‚é »çŽ‡
â€¢ ä¸åŒé »çŽ‡ç›¸äº’å”èª¿
â€¢ å±¤æ¬¡æ€§çš„ç™‚ç™’éŽç¨‹
â€¢ å…¨æ–¹ä½çš„èº«å¿ƒèª¿ç¯€

ðŸŒŠ é »çŽ‡çµ„åˆï¼š
1ï¸âƒ£ 7.83Hz + 10Hzï¼šæ·±åº¦æ”¾é¬† + å°ˆæ³¨
2ï¸âƒ£ 13Freq + 40Hzï¼šå°ˆæ³¨ + è¦ºçŸ¥æå‡
3ï¸âƒ£ ä¸‰é »çµ„åˆï¼šå…¨é¢å¹³è¡¡ç™‚æ³•
4ï¸âƒ£ æ¼¸é€²å¼é »çŽ‡ï¼šå¼•å°Žå¼æ·±åº¦ç™‚ç™’

ðŸ’Ž ç™‚æ•ˆç‰¹è‰²ï¼š
âœ… æ·±å±¤æ¬¡èº«å¿ƒç™‚ç™’
âœ… å¤šç¶­åº¦èƒ½é‡å¹³è¡¡
âœ… æ•´é«”æ€§èª¿å’Œæ•ˆæžœ
âœ… åŠ é€Ÿç™‚ç™’é€²ç¨‹
âœ… æŒä¹…ç©©å®šçš„æ•ˆæžœ

ðŸŽ¯ é©åˆæ—ç¾¤ï¼š
â€¢ éœ€è¦æ·±åº¦ç™‚ç™’çš„äºº
â€¢ å¤šé‡èº«å¿ƒå›°æ“¾è€…
â€¢ è¿½æ±‚å…¨é¢å¹³è¡¡çš„äºº
â€¢ å¸Œæœ›å¿«é€Ÿè¦‹æ•ˆçš„äºº

â­ ç¨ç‰¹å„ªå‹¢ï¼š
ç›¸æ¯”å–®ä¸€é »çŽ‡ï¼Œè¤‡åˆç™‚æ³•èƒ½å¤ ï¼š
â€¢ åŒæ™‚è™•ç†å¤šå€‹å•é¡Œ
â€¢ æä¾›æ›´è±å¯Œçš„é«”é©—
â€¢ é”åˆ°æ›´æ·±å±¤çš„ç™‚æ•ˆ
â€¢ é©æ‡‰å€‹äººåŒ–éœ€æ±‚

â° å»ºè­°ç™‚ç¨‹ï¼š
æ¯æ¬¡45-90åˆ†é˜ï¼Œæ¯é€±1-2æ¬¡ï¼Œé©åˆä½œç‚ºæ·±åº¦ç™‚ç™’çš„ä¸»è¦æ–¹æ¡ˆã€‚"""
        }

    def handle_postback(self, postback_data: str, user_id: str, with_quick_reply: bool = True) -> TextSendMessage:
        """
        Handle postback event and return appropriate response.

        Args:
            postback_data: Postback data from button
            user_id: LINE user ID
            with_quick_reply: Whether to include quick reply buttons

        Returns:
            TextSendMessage: Response message with optional quick reply
        """
        try:
            logger.info(f"Handling postback: {postback_data} for user: {user_id}")

            explanation = self.explanations.get(postback_data)
            if explanation:
                message = TextSendMessage(text=explanation)
                if with_quick_reply:
                    # Import here to avoid circular import
                    from .message_handler import MessageHandler
                    handler = MessageHandler()
                    message.quick_reply = handler.create_quick_reply_detailed()
                return message
            else:
                return TextSendMessage(text="æŠ±æ­‰ï¼Œç›®å‰æ²’æœ‰ç›¸é—œèªªæ˜Žè³‡è¨Šã€‚è«‹è¯ç¹«å®¢æœç²å¾—æ›´å¤šå¹«åŠ©ã€‚")

        except Exception as e:
            logger.error(f"Error handling postback {postback_data}: {e}")
            return TextSendMessage(text="ç³»çµ±è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚")

    def add_explanation(self, key: str, content: str):
        """Add or update explanation content"""
        self.explanations[key] = content

    def get_explanation(self, key: str) -> Optional[str]:
        """Get explanation content by key"""
        return self.explanations.get(key)

    def list_available_explanations(self) -> list:
        """List all available explanation keys"""
        return list(self.explanations.keys())


# Default postback handler instance
postback_handler = PostbackHandler()